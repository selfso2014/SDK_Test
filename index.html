<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <title>SeeSo Reading Game â€“ Debug</title>
    <meta name="description" content="SeeSo Eye Tracking ê¸°ë°˜ ë¦¬ë”© ê²Œì„ (iPhone í¬ë˜ì‹œ ë””ë²„ê·¸ìš©)" />
    <link rel="stylesheet" href="style.css" />

    <!-- COI ServiceWorker: GitHub Pagesì— COOP/COEP í—¤ë” ì¶”ê°€ â†’ SharedArrayBuffer í™œì„±í™” -->
    <!-- SeeSo WASM ë©€í‹°ìŠ¤ë ˆë“œì— í•„ìš”. ì²« ë¡œë“œ ì‹œ ìë™ ìƒˆë¡œê³ ì¹¨ë¨ -->
    <script src="coi-serviceworker.js"></script>
</head>

<body>

    <div id="app">
        <div id="header-bar">
            <h1>ğŸ‘ï¸ SeeSo Reading Game <span style="font-size:10px;color:#555;font-weight:400;">[DEBUG]</span></h1>
            <div id="header-stats">
                <span>Gaze: <b id="gaze-fps">0</b> Hz</span>
                <span>
                    <button id="btn-download-log"
                        style="background:#1a1a3a;color:#88aaff;border:1px solid #334;border-radius:4px;padding:2px 8px;cursor:pointer;font-size:11px;">ğŸ“¥
                        ë¡œê·¸ ì €ì¥</button>
                </span>
            </div>
        </div>

        <section id="section-idle" class="game-section active">
            <div class="idle-logo">ğŸ“–</div>
            <div class="idle-title">SeeSo ë¦¬ë”© ê²Œì„</div>
            <div class="idle-subtitle">Eye Tracking Reading Test Â· Debug Build</div>
            <div class="idle-badges">
                <span class="badge">ğŸ‘ï¸ 1-Point Calibration</span>
                <span class="badge">ğŸ“Š Memory Monitor</span>
                <span class="badge">ğŸ iOS Debug Mode</span>
            </div>
            <p class="idle-desc">
                ì‹œì„  ì¶”ì  ê¸°ìˆ ì„ ì´ìš©í•˜ì—¬ ì§€ë¬¸ì„ ì½ê³  ë¬¸ì œë¥¼ í’€ì–´ë³´ì„¸ìš”.<br />
                ì¹´ë©”ë¼ ê¶Œí•œê³¼ HTTPS í™˜ê²½ì´ í•„ìš”í•©ë‹ˆë‹¤.
            </p>
            <div style="margin-top:8px;">
                <!-- onclick: í´ë¦­ ì¦‰ì‹œ ì‹œê° í”¼ë“œë°± (ë¹„ë™ê¸° game.start() ì „ì— ì‹¤í–‰) -->
                <button id="btn-start" class="btn btn-primary"
                    onclick="this.textContent='ğŸ”„ ì‹œì‘ ì¤‘...'; this.disabled=true;">ğŸš€ ê²Œì„ ì‹œì‘</button>
            </div>
        </section>

        <section id="section-loading" class="game-section">
            <div class="loading-spinner"></div>
            <div class="loading-label">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”</div>
            <div class="loading-hint">AI ëª¨ë¸ì„ ë‹¤ìš´ë¡œë“œí•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤.<br />ì²« ì‹¤í–‰ ì‹œ 30ì´ˆê¹Œì§€ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        </section>

        <section id="section-calibration" class="game-section">
            <div id="cal-instruction">
                <h2>ğŸ¯ ì‹œì„  ìº˜ë¦¬ë¸Œë ˆì´ì…˜</h2>
                <p>í™”ë©´ì— ë‚˜íƒ€ë‚˜ëŠ” ì ì„ ì‘ì‹œí•´ ì£¼ì„¸ìš”</p>
            </div>
            <div id="cal-progress-wrap">
                <div id="cal-progress-track">
                    <div id="cal-progress-bar"></div>
                </div>
                <div id="cal-progress-text">0%</div>
            </div>
            <div id="cal-dot"></div>
        </section>

        <section id="section-reading" class="game-section">
            <h2 id="reading-title" style="font-size:20px;font-weight:700;color:#58a6ff;text-align:center;"></h2>
            <div id="reading-text-wrap">
                <p id="reading-text"></p>
            </div>
            <div class="reading-actions">
                <button id="btn-go-quiz" class="btn btn-primary">ë‹¤ ì½ì—ˆì–´ìš” â†’ ë¬¸ì œ í’€ê¸°</button>
            </div>

            <!-- â”€â”€ ë©”ëª¨ë¦¬ ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸ íŒ¨ë„ â”€â”€ -->
            <div id="stress-panel" style="
                margin-top:12px; padding:10px 14px;
                background:rgba(30,10,10,0.85); border:1px solid #553;
                border-radius:8px; font-size:12px; font-family:monospace;
                color:#ffa; max-width:420px; width:100%;
            ">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                    <span style="color:#f88;font-weight:bold;">âš¡ Memory Stress Test</span>
                    <button id="btn-stress-start" onclick="window.__stressStart()" style="
                        background:#5a1a1a;color:#faa;border:1px solid #a44;
                        border-radius:4px;padding:2px 10px;cursor:pointer;font-size:11px;
                    ">â–¶ START</button>
                    <button id="btn-stress-stop" onclick="MemoryStressTester.stop()" style="
                        background:#1a1a3a;color:#aaf;border:1px solid #44a;
                        border-radius:4px;padding:2px 10px;cursor:pointer;font-size:11px;
                        display:none;
                    ">â–  STOP</button>
                </div>
                <div id="stress-status" style="color:#ccc;">
                    ëŒ€ê¸° ì¤‘ â€” START ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ 10MBì”© ë¶€í•˜ë¥¼ ì¦ê°€ì‹œí‚µë‹ˆë‹¤
                </div>
                <div id="stress-bar-wrap" style="margin-top:6px;display:none;">
                    <div style="height:6px;background:#333;border-radius:3px;overflow:hidden;">
                        <div id="stress-bar"
                            style="height:100%;width:0%;background:linear-gradient(90deg,#f80,#f00);border-radius:3px;transition:width 0.5s;">
                        </div>
                    </div>
                    <div id="stress-bar-label" style="font-size:10px;color:#888;margin-top:2px;">0 / 300 MB</div>
                </div>
            </div>
        </section>

        <section id="section-quiz" class="game-section">
            <div id="quiz-question-wrap">
                <p id="quiz-question"></p>
            </div>
            <div id="quiz-options"></div>
        </section>

        <section id="section-result" class="game-section">
            <div class="result-emoji">ğŸ†</div>
            <div class="result-title">ê²Œì„ ì™„ë£Œ!</div>
            <div id="result-score">0 / 0</div>
            <div id="result-msg"></div>
            <div class="result-actions" style="margin-top:16px;">
                <button id="btn-play-again" class="btn btn-primary">ğŸ”„ ë‹¤ì‹œí•˜ê¸°</button>
                <button class="btn btn-secondary" onclick="MemoryLogger.downloadLogs()">ğŸ“¥ ë¡œê·¸ ì €ì¥</button>
            </div>
        </section>

        <canvas id="gaze-canvas"></canvas>
        <button id="btn-retry" class="btn btn-danger">ğŸ”„ ë‹¤ì‹œ ì‹œë„</button>
        <div id="status-text">ì¤€ë¹„ ì¤‘...</div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì „ëµ (ì´ì „ ì‹¤íŒ¨ ì›ì¸ ë¶„ì„ í›„ í™•ì •):

  âŒ ì‹¤íŒ¨ ì›ì¸:
    - seeso.min.js: ES Module (export êµ¬ë¬¸ å«) â†’ plain <script>ë¡œ ë¡œë“œ ë¶ˆê°€
    - easy-seeso.js: import './dist/seeso' (í™•ì¥ì ì—†ìŒ) â†’ ë¸Œë¼ìš°ì € 404 â†’ ë¡œë“œ ì‹¤íŒ¨
    - ê²°ê³¼: EasySeeso undefined â†’ SDK ì´ˆê¸°í™” ë¶ˆê°€

  âœ… í•´ê²°:
    1. memory-logger.js: plain <script> (ê°€ì¥ ë¨¼ì €, ë™ê¸° ì‹¤í–‰)
    2. <script type="module">: ëª¨ë“  ESM ë¡œë”©ê³¼ ìˆœì°¨ì  plain script ì£¼ì… ë‹´ë‹¹
       - easy-seeso.jsë¥¼ ESM import (ì´ ë•Œ seeso.min.js ê²½ë¡œë¥¼ .min.jsë¡œ ìˆ˜ì •)
       - ìˆ˜ì • ë¶ˆê°€ë©´: seeso.min.js ì§ì ‘ import í›„ window.__SeesoCore ë“±ë¡
         â†’ EasySeesoë¥¼ ì¸ë¼ì¸ìœ¼ë¡œ ì¬êµ¬í˜„
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

    <!-- 1. MemoryLogger ê°€ì¥ ë¨¼ì € (ë™ê¸°) -->
    <script src="memory-logger.js"></script>

    <!-- 2. ëª¨ë“  ESM + ìˆœì°¨ ë¡œë”©ì„ module script í•˜ë‚˜ë¡œ ì œì–´ -->
    <script type="module">
        // â”€â”€ í™˜ê²½ ì§„ë‹¨ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        MemoryLogger.info('ENV2', `crossOriginIsolated=${window.crossOriginIsolated} | SharedArrayBuffer=${typeof SharedArrayBuffer}`);

        // â”€â”€ helper: plain script ë™ì  ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const s = document.createElement('script');
                s.src = src;
                s.onload = () => { MemoryLogger.info('BOOT', `âœ… Loaded: ${src}`); resolve(); };
                s.onerror = () => { MemoryLogger.error('BOOT', `âŒ Failed: ${src}`); reject(new Error(src)); };
                document.body.appendChild(s);
            });
        }

        // â”€â”€ Step 1: seeso.min.jsë¥¼ ESM import â†’ window.__SeesoCore ë“±ë¡ â”€â”€
        let SeesoClass, InitErrType, CalAccuracy;
        try {
            const mod = await import('./dist/seeso.min.js');
            SeesoClass = mod.default || mod.Seeso;
            InitErrType = mod.InitializationErrorType;
            CalAccuracy = mod.CalibrationAccuracyCriteria;

            window.__SeesoCore = SeesoClass;
            window.__InitializationErrorType = InitErrType;
            window.__CalibrationAccuracyCriteria = CalAccuracy;

            MemoryLogger.info('BOOT', 'seeso.min.js ESM import OK', {
                SeesoClass: typeof SeesoClass,
                exports: Object.keys(mod).slice(0, 12),
            });
        } catch (e) {
            MemoryLogger.error('BOOT', 'seeso.min.js ESM import FAILED â€” SDK unavailable', {
                msg: e.message,
            });
            document.getElementById('status-text').textContent = 'âŒ SDK ë¡œë“œ ì‹¤íŒ¨: ' + e.message;
            // ì—¬ê¸°ì„œ ì¤‘ë‹¨í•˜ì§€ ì•Šê³  ê³„ì† ì§„í–‰ (EasySeeso ì—†ì´ë„ ë¡œê¹… ëª©ì ìœ¼ë¡œ)
        }

        // â”€â”€ Step 2: easy-seeso.jsë¥¼ ESM import â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // easy-seeso.js ë‚´ë¶€: import Seeso from './dist/seeso' (í™•ì¥ì ì—†ìŒ â†’ 404)
        // ë”°ë¼ì„œ easy-seeso.js ESM importëŠ” ì‹¤íŒ¨í•  ê²ƒ â†’ ì¸ë¼ì¸ EasySeesoë¡œ ëŒ€ì²´
        try {
            const easySeesoMod = await import('./easy-seeso.js');
            window.EasySeeso = easySeesoMod.default;
            MemoryLogger.info('BOOT', 'easy-seeso.js ESM import OK âœ…');
        } catch (e) {
            MemoryLogger.warn('BOOT', 'easy-seeso.js ESM import failed â†’ using inline EasySeeso', { msg: e.message });

            // â”€â”€ ì¸ë¼ì¸ EasySeeso (window.__SeesoCore ì‚¬ìš©) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // easy-seeso.jsì˜ í•µì‹¬ ê¸°ëŠ¥ë§Œ ì¬êµ¬í˜„
            if (window.__SeesoCore) {
                const _Seeso = window.__SeesoCore;
                const _InitErrType = window.__InitializationErrorType;
                const _CalCriteria = window.__CalibrationAccuracyCriteria;

                window.EasySeeso = class EasySeeso {
                    constructor() {
                        this.seeso = new _Seeso();
                        this.onGaze = null; this.onDebug = null;
                        this.onCalibrationNextPoint = null;
                        this.onCalibrationProgress = null;
                        this.onCalibrationFinished = null;
                        this._onGazeBind = null;
                        this._onCalFinBind = null;
                    }

                    async init(licenseKey, afterInitialized, afterFailed) {
                        await this.seeso.initialize(licenseKey).then((errCode) => {
                            if (_InitErrType && errCode === _InitErrType.ERROR_NONE || errCode === 0) {
                                afterInitialized();
                                this._onCalFinBind = this._onCalibrationFinished_.bind(this);
                                this.seeso.addCalibrationFinishCallback(this._onCalFinBind);
                                this._onGazeBind = this._onGaze_.bind(this);
                                this.seeso.addGazeCallback(this._onGazeBind);
                            } else {
                                MemoryLogger.error('EasySeeso', `init errCode: ${errCode}`);
                                afterFailed();
                            }
                        });
                    }

                    async startTracking(onGaze, onDebug) {
                        // [FIX-iOS] easy-seeso.jsì™€ ë™ì¼í•œ ìˆ˜ì •
                        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                        const videoConstraints = isIOS ? {
                            facingMode: { ideal: 'user' },
                            width: { ideal: 640, max: 1280 },
                            height: { ideal: 480, max: 720 },
                            frameRate: { max: 30 }
                        } : { facingMode: 'user' };
                        const stream = await navigator.mediaDevices.getUserMedia({ video: videoConstraints });
                        if (isIOS) {
                            stream.getVideoTracks().forEach(t => {
                                const s = t.getSettings();
                                MemoryLogger.info('EasySeeso', `[iOS] cam: ${s.facingMode} ${s.width}x${s.height} ${s.frameRate}fps`);
                            });
                        }
                        this.seeso.addDebugCallback(onDebug);
                        if (this.seeso.startTracking(stream)) {
                            this.onGaze = onGaze; this.onDebug = onDebug;
                            return true;
                        }
                        this.seeso.removeDebugCallback(onDebug);
                        return false;
                    }

                    stopTracking() {
                        this.seeso.stopTracking();
                        this.seeso.removeDebugCallback(this.onDebug);
                    }

                    startCalibration(onNext, onProgress, onFinished, points = 1) {
                        this.seeso.addCalibrationNextPointCallback(onNext);
                        this.seeso.addCalibrationProgressCallback(onProgress);
                        const ok = this.seeso.startCalibration(
                            points,
                            _CalCriteria ? _CalCriteria.Default : 0
                        );
                        if (ok) {
                            this.onCalibrationNextPoint = onNext;
                            this.onCalibrationProgress = onProgress;
                            this.onCalibrationFinished = onFinished;
                        } else {
                            this.seeso.removeCalibrationNextPointCallback(onNext);
                            this.seeso.removeCalibrationProgressCallback(onProgress);
                        }
                        return ok;
                    }

                    startCollectSamples() {
                        this.seeso.startCollectSamples();
                    }

                    stopCalibration() {
                        return this.seeso.stopCalibration();
                    }

                    deinit() {
                        if (this._onGazeBind) this.seeso.removeGazeCallback(this._onGazeBind);
                        if (this._onCalFinBind) this.seeso.removeCalibrationFinishCallback(this._onCalFinBind);
                        this.seeso.removeDebugCallback(this.onDebug);
                        this.seeso.deinitialize();
                    }

                    _onGaze_(gazeInfo) { if (this.onGaze) this.onGaze(gazeInfo); }
                    _onCalibrationFinished_(data) {
                        if (this.onCalibrationFinished) this.onCalibrationFinished(data);
                        this.seeso.removeCalibrationNextPointCallback(this.onCalibrationNextPoint);
                        this.seeso.removeCalibrationProgressCallback(this.onCalibrationProgress);
                        this.onCalibrationFinished = null;
                        this.onCalibrationProgress = null;
                        this.onCalibrationNextPoint = null;
                    }
                };

                MemoryLogger.info('BOOT', 'Inline EasySeeso registered using window.__SeesoCore âœ…');
            } else {
                MemoryLogger.error('BOOT', 'FATAL: Both easy-seeso.js and __SeesoCore unavailable');
                document.getElementById('status-text').textContent = 'âŒ SDK ë¡œë“œ ì‹¤íŒ¨ â€” ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”';
            }
        }

        // â”€â”€ Step 3: ë‚˜ë¨¸ì§€ plain scripts ìˆœì°¨ ë¡œë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        try {
            await loadScript('passage-data.js');
            await loadScript('seeso-manager.js');
            await loadScript('pang-detector.js');
            await loadScript('game.js');
            await loadScript('stress-tester.js');
            MemoryLogger.info('BOOT', 'âœ… All game scripts loaded. EasySeeso=' + typeof window.EasySeeso);

            // ìŠ¤íŠ¸ë ˆìŠ¤ í…ŒìŠ¤íŠ¸ START í•¸ë“¤ëŸ¬
            window.__stressStart = () => {
                document.getElementById('btn-stress-start').style.display = 'none';
                document.getElementById('btn-stress-stop').style.display = '';
                document.getElementById('stress-bar-wrap').style.display = '';
                MemoryStressTester.start((level, mb) => {
                    const statusEl = document.getElementById('stress-status');
                    const barEl = document.getElementById('stress-bar');
                    const labelEl = document.getElementById('stress-bar-label');
                    const MAX_MB = 300;
                    if (level === -1) {
                        // stopped
                        if (statusEl) statusEl.textContent = `â–  ì¤‘ì§€ë¨ (ì´ ${mb}MB í• ë‹¹ í›„ í•´ì œ)`;
                        document.getElementById('btn-stress-start').style.display = '';
                        document.getElementById('btn-stress-stop').style.display = 'none';
                        return;
                    }
                    if (statusEl) statusEl.innerHTML =
                        `Level <b style="color:#f80">${level}</b> | ` +
                        `<b style="color:#f44">${mb} MB</b> í• ë‹¹ ì¤‘ | ` +
                        `5ì´ˆ í›„ +10MB`;
                    if (barEl) barEl.style.width = Math.min(mb / MAX_MB * 100, 100) + '%';
                    if (labelEl) labelEl.textContent = `${mb} / ${MAX_MB} MB`;
                });
            };
        } catch (e) {
            MemoryLogger.error('BOOT', 'Script chain failed', { msg: e.message });
            document.getElementById('status-text').textContent = 'âŒ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨';
        }
    </script>

</body>

</html>